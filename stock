#!/usr/bin/env python3
################################################################################
#
# stocks - monitor the stock-market right from the Unix terminal!
#
# March 2014, Forhad Ahmed
# Updated December 2024 - Python 3, scrolling, add/remove/search
#
################################################################################

from urllib.request import Request, urlopen
import sys
import os
import time
import signal
import curses
import calendar
import traceback
import json
from datetime import datetime
from pathlib import Path

# Reduce escape key delay (default 1000ms is too slow)
os.environ.setdefault('ESCDELAY', '25')

# Settings persistence file
SETTINGS_FILE = Path.home() / '.stocks'
USER_AGENT = 'Mozilla/5.0'

# Check if key is an exit/close key (q, Q, or Esc)
def is_exit_key(ch): return ch == 27 or ch == ord('q') or ch == ord('Q')

# Check if symbol is already in the watchlist (case-insensitive)
def in_watchlist(symbol): return symbol.upper() in [s.upper() for s in stocks]

# Create HTTP request with standard User-Agent
def make_request(url):
    req = Request(url)
    req.add_header('User-Agent', USER_AGENT)
    return req
#end

# Get color attribute for positive/negative change value
def get_change_color(value, selected):
    if selected: return curses.A_REVERSE
    return curses.color_pair(COLOR_GREEN) if value >= 0 else curses.color_pair(COLOR_RED)
#end

# Load settings from ~/.stocks file
def load_settings():
    global stocks, visible_columns, sort_column, sort_mode
    if not SETTINGS_FILE.exists(): return
    try:
        with open(SETTINGS_FILE) as f:
            data = json.load(f)
            stocks = data.get('stocks', [])
            visible_columns = data.get('columns', visible_columns)
            sort_column = data.get('sort_column', 0)
            sort_mode = data.get('sort_mode', 0)
    except: pass
#end

# Save settings to ~/.stocks file
def save_settings():
    try:
        data = {'stocks': stocks, 'columns': visible_columns,
                'sort_column': sort_column, 'sort_mode': sort_mode}
        with open(SETTINGS_FILE, 'w') as f: json.dump(data, f, indent=2)
    except: pass
#end

################################################################################
# Yahoo Finance JSON API Provider (no dependencies, stdlib only)
################################################################################

# Fetch stock data using Yahoo Finance JSON API
def fetch_stock_data(symbols):
    if not symbols: return {}

    result = {}
    for sym in symbols:
        try:
            url = f'https://query1.finance.yahoo.com/v8/finance/chart/{sym.upper()}?interval=1d&range=1d'
            resp = urlopen(make_request(url), timeout=10)
            data = json.loads(resp.read().decode('utf-8'))

            chart = data.get('chart', {}).get('result', [{}])[0]
            meta = chart.get('meta', {})
            indicators = chart.get('indicators', {}).get('quote', [{}])[0]

            price = meta.get('regularMarketPrice', 0) or 0
            prev_close = meta.get('chartPreviousClose', price) or price
            change = price - prev_close if price and prev_close else 0
            change_pct = (change / prev_close * 100) if prev_close else 0

            # Get open from indicators (last value)
            open_prices = indicators.get('open', [])
            open_price = open_prices[-1] if open_prices and open_prices[-1] else prev_close

            result[sym] = {
                'symbol': sym.upper(),
                'name': meta.get('shortName', sym.upper()),
                'price': price,
                'change': change,
                'change_pct': change_pct,
                'prev_close': prev_close,
                'open': open_price or 0,
                'day_low': meta.get('regularMarketDayLow', 0) or 0,
                'day_high': meta.get('regularMarketDayHigh', 0) or 0,
                'volume': meta.get('regularMarketVolume', 0) or 0,
                'week52_low': meta.get('fiftyTwoWeekLow', 0) or 0,
                'week52_high': meta.get('fiftyTwoWeekHigh', 0) or 0,
            }
        except:
            result[sym] = None
        #end
    #end
    return result
#end

################################################################################
# Global state
################################################################################

win = None
COLOR_RED = None
COLOR_GREEN = None
COLOR_CYAN = None

stocks = []
stdata = {}
scroll_offset = 0
stock_index = 0
sort_column = 0
sort_mode = 0  # 0=none, 1=asc, 2=desc

# Input mode
INPUT_NONE = 0
INPUT_SEARCH = 1
INPUT_DELETE_CONFIRM = 2
input_mode = INPUT_NONE
input_buffer = ""

# Search results (from Yahoo search API)
search_results = []  # list of {'symbol': ..., 'name': ..., 'exchange': ...}
search_index = 0     # selected result index

# Sort constants
SORT_NONE = 0
SORT_UP = 1
SORT_DOWN = 2

# Column definitions: (key, header, width)
ALL_COLUMNS = [
    ('symbol',      'Symbol',    12),
    ('price',       'Price',     12),
    ('change',      'Change',    12),
    ('change_pct',  'Chg %',     10),
    ('day_low',     'Low',       12),
    ('day_high',    'High',      12),
    ('open',        'Open',      12),
    ('prev_close',  'PrevCls',   12),
    ('volume',      'Volume',    14),
    ('week52_low',  '52W Lo',    12),
    ('week52_high', '52W Hi',    12),
]

# Default visible columns (by key)
visible_columns = ['symbol', 'price', 'change', 'change_pct', 'volume']

# Settings mode
settings_mode = False
settings_index = 0

delta = 0

################################################################################
# SIGINT handler
################################################################################

def cleanup(sig, fr):
    global win
    if win:
        try: win.keypad(0); curses.nocbreak(); curses.echo(); curses.endwin()
        except: pass
    print("[quit]")
    sys.exit()
#end

signal.signal(signal.SIGINT, cleanup)

################################################################################
# Curses initialization
################################################################################

def init_curses():
    global win, COLOR_RED, COLOR_GREEN, COLOR_CYAN
    win = curses.initscr()
    curses.noecho()
    win.nodelay(1)
    win.keypad(1)
    curses.start_color()
    curses.use_default_colors()
    curses.init_pair(1, curses.COLOR_RED, -1)
    curses.init_pair(2, curses.COLOR_GREEN, -1)
    curses.init_pair(3, curses.COLOR_CYAN, -1)
    curses.init_pair(4, curses.COLOR_BLACK, curses.COLOR_WHITE)
    COLOR_RED, COLOR_GREEN, COLOR_CYAN = 1, 2, 3
    try: curses.curs_set(0)
    except: pass
#end

################################################################################
# Time calibration
################################################################################

def calibrate_delta():
    global delta
    try:
        resp = urlopen('http://www.google.com', timeout=5)
        tm = resp.headers.get('date', '')
        if not tm: return
        ts_str = tm.strip()
        if ts_str.endswith('GMT'): ts_str = ts_str[:-3].strip()
        if ',' in ts_str: ts_str = ts_str.split(',', 1)[1].strip()
        ts = datetime.strptime(ts_str, '%d %b %Y %H:%M:%S')
        ts = calendar.timegm(ts.utctimetuple())
        ct = calendar.timegm(datetime.now().utctimetuple())
        delta = ts - ct
    except: delta = 0
#end

################################################################################
# Data functions
################################################################################

def query_stocks():
    global stocks, stdata
    if not stocks: return
    data = fetch_stock_data(stocks)
    for sym in stocks:
        info = data.get(sym)
        if info: stdata[sym] = info
        elif sym not in stdata: stdata[sym] = None
#end

def add_stock(symbol):
    global stocks
    sym = symbol.strip().upper()
    if sym and not in_watchlist(sym):
        stocks.append(sym)
        save_settings()
        return True
    return False
#end

def remove_stock(index):
    global stocks, stock_index, scroll_offset
    if 0 <= index < len(stocks):
        sym = stocks[index]
        stocks.pop(index)
        if sym in stdata: del stdata[sym]
        if stock_index >= len(stocks): stock_index = max(0, len(stocks) - 1)
        save_settings()
        return True
    return False
#end

# Search Yahoo Finance for stocks matching prefix
def search_stocks(query):
    if not query: return []
    try:
        url = f'https://query1.finance.yahoo.com/v1/finance/search?q={query}&quotesCount=10&newsCount=0'
        resp = urlopen(make_request(url), timeout=10)
        data = json.loads(resp.read().decode('utf-8'))
        results = []
        for quote in data.get('quotes', []):
            qtype = quote.get('quoteType', '')
            if qtype in ('EQUITY', 'ETF', 'MUTUALFUND'):
                results.append({
                    'symbol': quote.get('symbol', ''),
                    'name': quote.get('shortname') or quote.get('longname', ''),
                    'exchange': quote.get('exchange', ''),
                    'type': qtype,
                })
        return results
    except: return []
#end

def get_sorted_stocks():
    if sort_mode == SORT_NONE: return stocks
    cols = get_visible_columns()
    if sort_column >= len(cols): return stocks
    sort_key = cols[sort_column][0]

    def get_key(sym):
        if sort_key == 'symbol': return sym
        info = stdata.get(sym)
        if not info: return 0
        return info.get(sort_key, 0)
    #end

    return sorted(stocks, key=get_key, reverse=(sort_mode == SORT_DOWN))
#end

################################################################################
# Display functions
################################################################################

def print_header(win):
    h, w = win.getmaxyx()
    gmt = time.mktime(datetime.now().utctimetuple()) + delta
    est = gmt + (3600) * (-5)
    tss = datetime.fromtimestamp(est).strftime('%a %b %d, %Y - %I:%M:%S%p')

    now_et = datetime.fromtimestamp(est)
    market_open = (now_et.weekday() < 5
                   and ((now_et.hour == 9 and now_et.minute >= 30)
                        or (10 <= now_et.hour < 16)))

    try:
        win.addstr(0, 1, tss + " EST")
        win.addstr(0, len(tss) + 6, "- US markets ")
        if market_open: win.addstr("open", curses.color_pair(COLOR_GREEN))
        else:           win.addstr("closed", curses.color_pair(COLOR_RED))
        count_str = f"  [{len(stocks)} stocks]"
        win.addstr(0, w - len(count_str) - 1, count_str)
    except curses.error: pass
#end

# Get list of (key, header, width) for visible columns
def get_visible_columns(): return [(k, h, w) for k, h, w in ALL_COLUMNS if k in visible_columns]

def print_columns(win):
    try:
        h, w = win.getmaxyx()
        y, x = 2, 1
        cols = get_visible_columns()
        for i, (key, header, width) in enumerate(cols):
            if i == sort_column and sort_mode != SORT_NONE:
                header = header + ("▲" if sort_mode == SORT_UP else "▼")
            win.addstr(y, x, header.ljust(width - 1), curses.A_BOLD)
            x += width
        win.addstr(y + 1, 1, "─" * (w - 2), curses.A_DIM)
    except curses.error: pass
#end

# Display search results panel
def print_search_results(win):
    if not search_results: return
    h, w = win.getmaxyx()
    start_y = 4
    max_rows = min(len(search_results), h - 7)

    try:
        # Header
        win.addstr(start_y, 1, f"Search Results ({len(search_results)} found)", curses.A_BOLD)
        win.addstr(start_y + 1, 1, "Symbol     Name                         Price       Change", curses.A_DIM)

        # Results list
        for i in range(max_rows):
            y = start_y + 2 + i
            if y >= h - 2: break

            result = search_results[i]
            sym = result.get('symbol', '')[:10]
            name = result.get('name', '')[:25]
            data = result.get('data')
            selected = (i == search_index)

            # Check if already in watchlist
            in_list = in_watchlist(sym)

            try:
                if selected: win.addstr(y, 1, " " * (w - 2), curses.A_REVERSE)
                attr = curses.A_REVERSE if selected else 0
                win.addstr(y, 2, sym.ljust(10), attr | curses.A_BOLD)
                win.addstr(y, 13, name.ljust(26), attr)
                if data:
                    price = data.get('price', 0)
                    change = data.get('change', 0)
                    chg_str = f"+${change:.2f}" if change >= 0 else f"-${abs(change):.2f}"
                    win.addstr(y, 40, f"${price:.2f}".ljust(12), attr)
                    win.addstr(y, 52, chg_str.ljust(10), get_change_color(change, selected) | attr)
                else:
                    win.addstr(y, 40, "N/A".ljust(12), attr | curses.A_DIM)
                if in_list: win.addstr(y, 65, "(added)", attr | curses.A_DIM)
            except curses.error: pass
    except curses.error: pass
#end

# Display settings panel for column configuration
def print_settings(win):
    global settings_index
    h, w = win.getmaxyx()
    start_y = 4

    try:
        win.addstr(start_y, 1, "Column Settings", curses.A_BOLD)
        win.addstr(start_y, 20, "[Up/Down] select  [Space] toggle  [Esc] close", curses.A_DIM)

        for i, (key, header, width) in enumerate(ALL_COLUMNS):
            y = start_y + 2 + i
            if y >= h - 2: break
            selected = (i == settings_index)
            enabled = key in visible_columns
            is_symbol = (key == 'symbol')

            try:
                if selected: win.addstr(y, 1, " " * (w - 2), curses.A_REVERSE)
                attr = curses.A_REVERSE if selected else 0
                check = "[*]" if is_symbol else ("[x]" if enabled else "[ ]")
                win.addstr(y, 2, check, attr)
                win.addstr(y, 6, header.ljust(12), attr | curses.A_BOLD)
                win.addstr(y, 19, f"(width: {width})", attr | curses.A_DIM)
            except curses.error: pass
    except curses.error: pass
#end

def print_stocks(win):
    global scroll_offset
    h, w = win.getmaxyx()
    visible_rows = h - 5
    start_y = 4

    if settings_mode: print_settings(win); return
    if search_results: print_search_results(win); return

    sstocks = get_sorted_stocks()
    total = len(sstocks)

    # Adjust scroll
    if stock_index < scroll_offset: scroll_offset = stock_index
    elif stock_index >= scroll_offset + visible_rows: scroll_offset = stock_index - visible_rows + 1
    scroll_offset = max(0, min(scroll_offset, max(0, total - visible_rows)))

    for i in range(visible_rows):
        idx = scroll_offset + i
        y = start_y + i
        if y >= h - 2: break
        if idx >= total: continue

        sym = sstocks[idx]
        info = stdata.get(sym)
        selected = (idx == stock_index)

        try:
            if selected: win.addstr(y, 0, " " * (w - 1), curses.A_REVERSE)
            x = 1
            attr = curses.A_REVERSE if selected else 0
            cols = get_visible_columns()

            for key, header, width in cols:
                val_str = ""
                color = attr

                if key == 'symbol':
                    val_str = sym[:width-1]
                elif info:
                    val = info.get(key, 0)
                    if key in ('price', 'day_low', 'day_high', 'open',
                               'prev_close', 'week52_low', 'week52_high'):
                        val_str = "$%.2f" % val
                    elif key == 'change':
                        val_str = "+$%.2f" % val if val >= 0 else "-$%.2f" % abs(val)
                        color = get_change_color(val, selected)
                    elif key == 'change_pct':
                        val_str = "+%.2f%%" % val if val >= 0 else "%.2f%%" % val
                        color = get_change_color(val, selected)
                    elif key == 'volume':
                        if val >= 1e9: val_str = "%.2fB" % (val / 1e9)
                        elif val >= 1e6: val_str = "%.2fM" % (val / 1e6)
                        elif val >= 1e3: val_str = "%.1fK" % (val / 1e3)
                        else: val_str = str(int(val))
                else:
                    val_str = "-"

                win.addstr(y, x, val_str.ljust(width - 1), color | attr)
                x += width
        except curses.error: pass

    if total > visible_rows:
        try:
            indicator = f" [{scroll_offset + 1}-{min(scroll_offset + visible_rows, total)}/{total}]"
            win.addstr(h - 2, w - len(indicator) - 1, indicator, curses.color_pair(COLOR_CYAN))
        except curses.error: pass
#end

def print_menu(win):
    h, w = win.getmaxyx()
    y = h - 1

    try:
        win.addstr(y, 0, " " * (w - 1))
        if input_mode == INPUT_DELETE_CONFIRM:
            sstocks = get_sorted_stocks()
            sym = sstocks[stock_index] if 0 <= stock_index < len(sstocks) else "?"
            win.addstr(y, 1, f"delete {sym}? [Y/n] ", curses.A_BOLD)
        elif input_mode == INPUT_SEARCH:
            win.addstr(y, 1, "search: " + input_buffer + "_", curses.A_BOLD)
        elif settings_mode:
            win.addstr(y, 1, "[up/down] select  [space] toggle  [q] close", curses.color_pair(COLOR_CYAN))
        elif search_results:
            win.addstr(y, 1, "[up/down] select  [enter] add  [q] close", curses.color_pair(COLOR_CYAN))
        else:
            win.addstr(y, 1, "[a]dd [d]el [tab] sort [c]ols [q]uit", curses.color_pair(COLOR_CYAN))
    except curses.error: pass
#end

################################################################################
# Input handling
################################################################################

def handle_input(ch):
    global input_mode, input_buffer, search_results, search_index
    global stock_index, scroll_offset, sort_column, sort_mode, stocks
    global settings_mode, settings_index, visible_columns

    sstocks = get_sorted_stocks()
    total = len(sstocks)

    if input_mode != INPUT_NONE:
        if is_exit_key(ch):
            input_mode = INPUT_NONE; input_buffer = ""
        elif input_mode == INPUT_DELETE_CONFIRM:
            if (ch == ord('y') or ch == ord('Y')
                    or ch == 10 or ch == curses.KEY_ENTER):
                sstocks = get_sorted_stocks()
                if sstocks and 0 <= stock_index < len(sstocks):
                    sym = sstocks[stock_index]
                    idx = stocks.index(sym) if sym in stocks else -1
                    if idx >= 0: remove_stock(idx)
            input_mode = INPUT_NONE; input_buffer = ""
        elif ch == 10 or ch == curses.KEY_ENTER:
            if input_mode == INPUT_SEARCH and input_buffer:
                words = input_buffer.strip().split()
                if len(words) > 1:
                    added = sum(1 for word in words if add_stock(word))
                    if added > 0: query_stocks()
                else:
                    search_results = search_stocks(input_buffer.strip())
                    search_index = 0
                    if search_results:
                        symbols = [r['symbol'] for r in search_results]
                        prices = fetch_stock_data(symbols)
                        for r in search_results: r['data'] = prices.get(r['symbol'])
            input_mode = INPUT_NONE; input_buffer = ""
        elif (ch == curses.KEY_BACKSPACE
              or ch == 127 or ch == 8): input_buffer = input_buffer[:-1]
        elif 32 <= ch <= 126: input_buffer += chr(ch)
        return True

    # Settings mode
    if settings_mode:
        if is_exit_key(ch): settings_mode = False
        elif ch == curses.KEY_UP and settings_index > 0: settings_index -= 1
        elif (ch == curses.KEY_DOWN
              and settings_index < len(ALL_COLUMNS) - 1): settings_index += 1
        elif ch == ord(' '):
            key = ALL_COLUMNS[settings_index][0]
            if key != 'symbol':
                if key in visible_columns: visible_columns.remove(key)
                else: visible_columns.append(key)
                save_settings()
        return True

    # Search results mode
    if search_results:
        if is_exit_key(ch): search_results = []; search_index = 0
        elif ch == curses.KEY_UP and search_index > 0: search_index -= 1
        elif (ch == curses.KEY_DOWN
              and search_index < len(search_results) - 1): search_index += 1
        elif ch == 10 or ch == curses.KEY_ENTER:
            if 0 <= search_index < len(search_results):
                sym = search_results[search_index].get('symbol', '')
                if sym and not in_watchlist(sym): add_stock(sym); query_stocks()
        return True

    # Normal mode
    if is_exit_key(ch): cleanup(0, 0)
    elif (ch == ord('a') or ch == ord('A')
          or ch == ord('/')): input_mode = INPUT_SEARCH; input_buffer = ""
    elif ch == ord('d') or ch == ord('D'):
        if sstocks and 0 <= stock_index < len(sstocks):
            input_mode = INPUT_DELETE_CONFIRM; input_buffer = ""
    elif ch == 9:
        cols = get_visible_columns()
        if sort_mode == SORT_NONE: sort_mode = SORT_UP
        sort_column = (sort_column + 1) % len(cols)
        save_settings()
    elif ch == ord('c') or ch == ord('C'): settings_mode = True; settings_index = 0
    elif ch == curses.KEY_UP and stock_index > 0: stock_index -= 1
    elif ch == curses.KEY_DOWN and stock_index < total - 1: stock_index += 1
    elif ch == curses.KEY_PPAGE: stock_index = max(0, stock_index - 10)
    elif ch == curses.KEY_NPAGE: stock_index = min(total - 1, stock_index + 10) if total > 0 else 0
    elif ch == curses.KEY_HOME: stock_index = 0; scroll_offset = 0
    elif ch == curses.KEY_END: stock_index = max(0, total - 1)
    elif ch == 10 or ch == curses.KEY_ENTER: sort_mode = (sort_mode + 1) % 3; save_settings()
    return False
#end

################################################################################
# Main update loop
################################################################################

def update(win, ch, do_query):
    if ch > 0: handle_input(ch)
    if do_query: query_stocks()
    win.erase()
    print_header(win)
    print_columns(win)
    print_stocks(win)
    print_menu(win)
    win.refresh()
#end

################################################################################
# Main
################################################################################

def main():
    global win, stocks

    calibrate_delta()
    load_settings()

    if len(sys.argv) > 1:
        stocks = [s.upper() for s in sys.argv[1:]]
        save_settings()

    if not stocks:
        print("Usage: stock [symbol1] [symbol2] ...")
        print("Example: stock aapl goog msft")
        print("Stocks are saved to ~/.stocks for persistence")
        sys.exit(1)

    init_curses()
    log = open(".crash", "a")
    ticks = 0

    try:
        while True:
            if ticks % 40 == 0: update(win, 0, True)
            ch = win.getch()
            if ch > 0: update(win, ch, False)
            time.sleep(0.05)
            ticks += 1
    except:
        log.write(traceback.format_exc())
        log.write('------\n')
    finally:
        log.close()
        cleanup(0, 0)
#end

if __name__ == "__main__": main()
